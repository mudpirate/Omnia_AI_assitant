generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"] // Enable extensions
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector] // Activate pgvector
}

// --- ENUMS (Strict Filtering) ---
enum StockStatus {
  IN_STOCK
  OUT_OF_STOCK
}

enum StoreName {
  XCITE
  BEST_KW
  NOON_KW
  JARIR
  BLINK
}

enum Category {
  MOBILE_PHONE
  LAPTOP
  HEADPHONE
  EARPHONE
  TABLET
  WATCH
  ACCESSORY
}

model Product {
  id          String    @id @default(cuid())

  // --- 1. IDENTITY & RAW DATA ---
  storeName   StoreName 
  title       String    
  // We keep the raw description purely as backup/metadata. 
  // It is NOT used for search directly anymore.
  description String?   @db.Text 

  // --- 2. THE "CASCADING CONTEXT" FIELDS ---
  
  // A. The Human-Readable String
  // This stores the result of: [Brand] + [Title] + [Specs] + [Price]
  // The LLM reads THIS field to generate its answer.
  searchKey   String    @db.Text 

  // B. The Machine-Readable Vector
  // This stores the embedding of 'searchKey'.
  // 1536 is the standard dimension for OpenAI text-embedding-3-small
  descriptionEmbedding Unsupported("vector(1536)")? 

  // C. Structured Specs (For Hard Filtering)
  // { "ram": "16GB", "storage": "1TB", "color": "Black" }
  specs       Json?     

  // --- 3. HARD FILTERS ---
  category    Category  
  price       Float     
  stock       StockStatus @default(IN_STOCK)
  brand       String

  // --- 4. METADATA ---
  imageUrl    String    @default("https://example.com/placeholder.png")
  productUrl  String    @default("https://example.com/placeholder-url")
  scrapedAt   DateTime  @default(now())
  lastSeenAt  DateTime  @updatedAt
  
  couponId    String?
  coupon      Coupon?   @relation(fields: [couponId], references: [id], onDelete: SetNull)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // --- INDEXES ---
  @@unique([storeName, productUrl], map: "uniq_store_producturl")
  @@index([storeName], map: "idx_store")
  @@index([category], map: "idx_category") 
  @@index([price], map: "idx_price")       
}

model Coupon {
  id          String    @id @default(cuid())
  storeName   StoreName
  title       String
  code        String
  expiryDate  DateTime?
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([storeName, code])
  @@index([expiryDate])
}

// Add this to your schema.prisma file

// In schema.prisma

model WebSearchCache {
  id        String   @id @default(uuid())
  query     String
  response  Json
  // IMPORTANT: This requires the vector extension
  embedding Unsupported("vector(1536)") 
  createdAt DateTime @default(now())
}